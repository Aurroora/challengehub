{% extends 'challenges/base.html' %}

{% block title %}ChallengeHub - –û—Ç–º–µ—Ç–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h4 class="card-title mb-0">üìù –û—Ç–º–µ—Ç–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</h4>
            </div>
            <div class="card-body">
                {% if existing_checkin %}
                <div class="alert alert-warning">
                    <strong>–í—ã —É–∂–µ –æ—Ç–º–µ—Ç–∏–ª–∏—Å—å —Å–µ–≥–æ–¥–Ω—è</strong>
                    <p class="mb-0">–ú–æ–∂–µ—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –æ—Ç–º–µ—Ç–∫—É –Ω–∏–∂–µ. –û–Ω–∞ –∑–∞–º–µ–Ω–∏—Ç –ø—Ä–µ–¥—ã–¥—É—â—É—é.</p>
                </div>
                {% endif %}
                
                <div class="mb-4">
                    <h5>{{ user_challenge.title }}</h5>
                    <p class="text-muted">
                        –î–µ–Ω—å {{ user_challenge.days_passed }} –∏–∑ {{ user_challenge.duration_days }}
                        | –ü—Ä–æ–≥—Ä–µ—Å—Å: {{ user_challenge.completion_percentage }}%
                    </p>
                    
                    <div class="progress mb-2" style="height: 20px;">
                        <div class="progress-bar bg-success" 
                            data-width="{{ user_challenge.completion_percentage }}"
                            id="progress-bar">
                            {{ user_challenge.completion_percentage }}%
                        </div>
                    </div>

                    <script>
                    document.addEventListener('DOMContentLoaded', function() {
                        const progressBar = document.getElementById('progress-bar');
                        const width = progressBar.getAttribute('data-width');
                        progressBar.style.width = width + '%';
                    });
                    </script>

                    {% if user_challenge.days_passed == user_challenge.duration_days and user_challenge.status == 'active' %}
                    <div class="alert alert-success">
                        <h6>üéâ –≠—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–Ω—å —á–µ–ª–ª–µ–Ω–¥–∂–∞!</h6>
                        <p class="mb-0">–ü–æ—Å–ª–µ –æ—Ç–º–µ—Ç–∫–∏ —Å–µ–≥–æ–¥–Ω—è —á–µ–ª–ª–µ–Ω–¥–∂ –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω.</p>
                    </div>
                    {% endif %}
                    
                    <div class="d-flex justify-content-between small text-muted">
                        <span>–ù–∞—á–∞–ª–æ: {{ user_challenge.start_date|date:"d.m.Y" }}</span>
                        <span>–û–∫–æ–Ω—á–∞–Ω–∏–µ: {{ user_challenge.end_date|date:"d.m.Y" }}</span>
                    </div>
                </div>
                
                <form method="post">
                    {% csrf_token %}
                    
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" name="is_completed" 
                                   id="id_is_completed" value="true" 
                                   {% if existing_checkin and existing_checkin.is_completed %}checked{% else %}checked{% endif %}>
                            <label class="form-check-label" for="id_is_completed">
                                <strong>‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ —Å–µ–≥–æ–¥–Ω—è</strong>
                            </label>
                        </div>
                        <div class="form-text">–û—Ç–º–µ—Ç—å—Ç–µ, –µ—Å–ª–∏ –≤—ã–ø–æ–ª–Ω–∏–ª–∏ –∑–∞–¥–∞–Ω–∏–µ —Å–µ–≥–æ–¥–Ω—è</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="id_rating" class="form-label">–ö–∞–∫ –ø—Ä–æ—à–µ–ª –¥–µ–Ω—å?</label>
                        <select name="rating" class="form-select" id="id_rating">
                            <option value="">–ù–µ –æ—Ü–µ–Ω–∏–≤–∞—Ç—å</option>
                            <option value="1" {% if existing_checkin and existing_checkin.rating == 1 %}selected{% endif %}>üòû –ü–ª–æ—Ö–æ</option>
                            <option value="2" {% if existing_checkin and existing_checkin.rating == 2 %}selected{% endif %}>üòê –ù–æ—Ä–º–∞–ª—å–Ω–æ</option>
                            <option value="3" {% if existing_checkin and existing_checkin.rating == 3 %}selected{% endif %}>üôÇ –•–æ—Ä–æ—à–æ</option>
                            <option value="4" {% if existing_checkin and existing_checkin.rating == 4 %}selected{% endif %}>üòä –û—Ç–ª–∏—á–Ω–æ</option>
                            <option value="5" {% if existing_checkin and existing_checkin.rating == 5 %}selected{% endif %}>ü§© –°—É–ø–µ—Ä!</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="id_notes" class="form-label">–ó–∞–º–µ—Ç–∫–∏ –∑–∞ –¥–µ–Ω—å (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                        <textarea name="notes" class="form-control" id="id_notes" rows="3" 
                                  placeholder="–ß—Ç–æ –ø–æ–ª—É—á–∏–ª–æ—Å—å? –ß—Ç–æ –±—ã–ª–æ —Å–ª–æ–∂–Ω–æ?">{% if existing_checkin %}{{ existing_checkin.notes }}{% endif %}</textarea>
                    </div>
                    
                    <div class="alert alert-info">
                        <h6>–°–µ–≥–æ–¥–Ω—è: {{ today|date:"d.m.Y" }}</h6>
                        <p class="mb-0">–≠—Ç–∞ –æ—Ç–º–µ—Ç–∫–∞ –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –∑–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–º –¥–Ω–µ–º.</p>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex">
                        <button type="submit" class="btn btn-success btn-lg me-md-2">
                            üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç–º–µ—Ç–∫—É
                        </button>
                        <a href="{% url 'profile' %}" class="btn btn-outline-secondary btn-lg">
                            ‚Üê –ù–∞–∑–∞–¥ –≤ –ø—Ä–æ—Ñ–∏–ª—å
                        </a>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-body">
                <h6>–ò—Å—Ç–æ—Ä–∏—è –æ—Ç–º–µ—Ç–æ–∫</h6>
                {% if user_challenge.checkins.all %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>–î–∞—Ç–∞</th>
                                    <th>–°—Ç–∞—Ç—É—Å</th>
                                    <th>–û—Ü–µ–Ω–∫–∞</th>
                                    <th>–ó–∞–º–µ—Ç–∫–∏</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for checkin in user_challenge.checkins.all|slice:":10" %}
                                <tr>
                                    <td>
                                        {{ checkin.date|date:"d.m.Y" }}
                                        {% if checkin.date == today %}
                                            <span class="badge bg-info">–°–µ–≥–æ–¥–Ω—è</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if checkin.is_completed %}
                                            <span class="badge bg-success">‚úÖ</span>
                                        {% else %}
                                            <span class="badge bg-danger">‚ùå</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if checkin.rating %}
                                            {% if checkin.rating == 1 %}üòû
                                            {% elif checkin.rating == 2 %}üòê
                                            {% elif checkin.rating == 3 %}üôÇ
                                            {% elif checkin.rating == 4 %}üòä
                                            {% elif checkin.rating == 5 %}ü§©
                                            {% endif %}
                                        {% else %}
                                            <span class="text-muted">‚Äî</span>
                                        {% endif %}
                                    </td>
                                    <td class="small">{{ checkin.notes|truncatechars:30|default:"‚Äî" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% if user_challenge.checkins.count > 10 %}
                    <p class="text-muted small mt-2 mb-0">–ü–æ–∫–∞–∑–∞–Ω–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –æ—Ç–º–µ—Ç–æ–∫ –∏–∑ {{ user_challenge.checkins.count }}</p>
                    {% endif %}
                {% else %}
                    <p class="text-muted mb-0">–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–º–µ—Ç–æ–∫. –°–¥–µ–ª–∞–π—Ç–µ –ø–µ—Ä–≤—É—é!</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}